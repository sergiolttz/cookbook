{% extends '__base.html' %}
{% block content %}
<h1>Crear Receta</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}

    <h2>Ingredientes</h2>
    <div id="ingredient-formset-container">
        {{ ingredient_formset.management_form }}
        {% for ingredient_form in ingredient_formset %}
        <div class="ingredient-form">
            {{ ingredient_form.as_p }}
            <button type="button" class="remove-ingredient">Eliminar Ingrediente</button>
        </div>
        {% endfor %}
    </div>
    <button type="button" id="add-ingredient">Agregar Ingrediente</button>

    <h2>Pasos</h2>
    <div id="step-formset-container">
        {{ step_formset.management_form }}
        {% for step_form in step_formset %}
        <div class="step-form">
            {{ step_form.as_p }}
            <button type="button" class="remove-step">Eliminar Paso</button>
        </div>
        {% endfor %}
    </div>
    <button type="button" id="add-step">Agregar Paso</button>

    <button type="submit">Guardar Receta</button>
    <a href="{% url 'recipes-list' %}"><button type="button">Cancelar</button></a>
</form>

<script>
    // Agregar un nuevo formulario de ingrediente al hacer clic en el bot贸n
    const addIngredientButton = document.getElementById('add-ingredient');
    const ingredientFormsetContainer = document.getElementById('ingredient-formset-container');
    const ingredientFormsetPrefix = '{{ ingredient_formset.prefix }}';
    let ingredientFormCount = parseInt('{{ ingredient_formset.total_form_count }}');
    const ingredientEmptyFormHtml = `{{ ingredient_empty_form_html|escapejs }}`.replace(/__prefix__/g, ingredientFormCount);

    addIngredientButton.addEventListener('click', function () {
        const newForm = document.createElement('div');
        newForm.innerHTML = ingredientEmptyFormHtml.replace(/__prefix__/g, ingredientFormCount);
        ingredientFormsetContainer.appendChild(newForm);
        ingredientFormCount++;
        document.getElementById('id_ingredients-TOTAL_FORMS').value = ingredientFormCount;

        // Agregar el bot贸n de eliminar al nuevo formulario
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = 'Eliminar Ingrediente';
        removeButton.classList.add('remove-ingredient');
        newForm.appendChild(removeButton);
    });

    // Agregar un nuevo formulario de paso al hacer clic en el bot贸n
    const addStepButton = document.getElementById('add-step');
    const stepFormsetContainer = document.getElementById('step-formset-container');
    const stepFormsetPrefix = '{{ step_formset.prefix }}';
    let stepFormCount = parseInt('{{ step_formset.total_form_count }}');
    const stepEmptyFormHtml = `{{ step_empty_form_html|escapejs }}`.replace(/__prefix__/g, stepFormCount);

    addStepButton.addEventListener('click', function () {
        const newForm = document.createElement('div');
        newForm.innerHTML = stepEmptyFormHtml.replace(/__prefix__/g, stepFormCount);
        stepFormsetContainer.appendChild(newForm);
        stepFormCount++;
        document.getElementById('id_steps-TOTAL_FORMS').value = stepFormCount;

        // Agregar el bot贸n de eliminar al nuevo formulario
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = 'Eliminar Paso';
        removeButton.classList.add('remove-step');
        newForm.appendChild(removeButton);
    });

    // Eliminar ingredientes y pasos al hacer clic en los botones de eliminar
    ingredientFormsetContainer.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-ingredient')) {
            event.target.parentElement.remove();
            ingredientFormCount--;
            document.getElementById('id_ingredients-TOTAL_FORMS').value = ingredientFormCount;
        }
    });

    stepFormsetContainer.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-step')) {
            event.target.parentElement.remove();
            stepFormCount--;
            document.getElementById('id_steps-TOTAL_FORMS').value = stepFormCount;
        }
    });
</script>
{% endblock %}